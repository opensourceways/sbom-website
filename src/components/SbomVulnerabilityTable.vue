<template>
  <div class="packageBug-container sbom-container">
    <div class="query-list">
      <div class="query-item">
        <span class="label">漏洞编号：</span> 
        <el-input 
          v-model="vulId" 
          placeholder="输入漏洞编号搜索" 
          :prefix-icon="Search"
          @keyup.enter="search" 
          @blur="search"
        />
      </div>
      <div class="query-item">
        <span class="label">漏洞级别：</span>
        <el-select v-model="vulSeverity" clearable placeholder="请选择" @change="search">
          <el-option
            v-for="(item, itemIndex) in vulSeverityList"
            :key="itemIndex"
            :label="item.label"
            :value="item.prop"
          />
        </el-select>
      </div>
    </div>
    <div class="sbom-table">
      <el-table
        :data="tableData" 
        stripe 
        border
        highlight-current-row 
        scrollbar-always-on
      >
        <template #empty>
          <div class="no-data">
            <img src="@/assets/images/no-data.png" alt="" />
            <p>暂无相关内容</p>
          </div>
        </template>
        <template v-for="(col,colIndex) in columns" :key="colIndex">
          <template v-if="col.prop==='purl'">
            <el-table-column v-if="!isInDialog" label="漏洞关联组件purl" width="400" show-overflow-tooltip>
              <template #default="scope">
                <span>{{ scope.row.purl }}</span>
              </template>
            </el-table-column>
          </template>
          <el-table-column 
            v-else
            :label="col.label"
            :width="col.width"
            :show-overflow-tooltip="col.showTooltip"
          >
            <template #default="scope">
              <div v-if="col.type === 'link'" @click="openEchart(scope.row)" class="link">{{ scope.row[col.prop] }}</div>
              <div v-else-if="col.hasBgcolor" :class="['bgColor', formatCellColor(scope.row[col.prop])]">{{ scope.row[col.prop] }}</div>
              <div v-else-if="col.type === 'button'" class="link" @click="goPath(scope.row)">查看</div>
              <span v-else>{{ scope.row[col.prop] }}</span>
            </template>
          </el-table-column>
        </template>
      </el-table>
      <div class="sbom-pagination">
        <el-pagination 
          layout="total, sizes, prev, pager, next, jumper" 
          :page-sizes="[10, 15, 20, 25, 30]"
          :total="pagination.total" 
          :page-size="pagination.pageSize" 
          v-model:page-size="pagination.pageSize" 
          v-model:currentPage="pagination.pageNum"
          @current-change="handlePageChange" 
          @size-change="handleSizeChange"
        />
      </div>
    </div>
    <el-dialog
      title="漏洞影响范围"
      v-if="showEchartDialog"
      v-model="showEchartDialog"
      :close-on-click-modal="false"
      width="70%"
      append-to-body
      custom-class="sbom-dialog"
    >
    <div class="graphChart">
      <div class="legendBox">
        <div class="item" v-for="(item, itemIndex) in graphColors" :key="itemIndex">
          <i class='dot' :style="{ backgroundColor: item.color }"></i>
          {{ item.label }}
        </div>
      </div>
      <div class="chart">
        <SbomEchart 
          chartId="sbomVulnerability"
          chartType="graph"
          :dataList="chartData"
          @echartsClick="echartsClick"
        />
      </div>
    </div>
    </el-dialog>
  </div>
</template>

<script lang="ts">
import { defineComponent, ref } from "vue";
import SbomDataService from "@/services/SbomDataService";
import ResponseData from "@/types/ResponseData";
import SbomEchart from '@/views/SbomDashboard/SbomEchart.vue';
import { vulSeverityList } from "@/utils"
import { Search } from '@element-plus/icons-vue'
import { ElMessage } from 'element-plus';
import { mapGetters} from 'vuex';
function defaultPagination() {
  return {
    pageNum: 1,
    pageSize: 10,
    total: 0
  }
}
export default defineComponent({
  name: "SbomVulnerabilityTable",
  components: {
    SbomEchart
  },
  props: {
    packageId: {
      type: String,
      default: ''
    },
    severity: {
      type: String,
      default: ''
    },
    productName: {
      type: String,
      default: ''
    },
    isInDialog: {
      type: Boolean,
      default: false
    },
  },
  data() {
    return {
      Search: Search,
      columns: [
        { label: '漏洞编号', prop: 'vulId', type: 'link', width: 250 },
        { label: '漏洞评分系统', prop: 'scoringSystem', width: 250 },
        { label: '漏洞评分', prop: 'score', width: 250, hasBgcolor: true },
        { label: '漏洞评分向量', prop: 'vector', width: 400, showTooltip: true },
        { label: '漏洞关联组件purl', prop: 'purl', width: 400, showTooltip: true },
        { label: '操作', prop: 'operate', type: 'button' },
      ],
      pagination: defaultPagination(),
      tableData: [] as Map<string, any>[],
      showEchartDialog: false,
      chartData: {},
      graphColors: [
        { label: '漏洞', prop: 'vulnerability', color: '#FF0000' },
        { label: '漏洞影响的组件', prop: 'dependency', color: '#0dcfcf' },
        { label: '漏洞影响的软件', prop: 'package', color: '#FF9126' },
        { label: '漏洞影响的传递性依赖', prop: 'transitiveDep', color: '#5A94F8' },
      ],
      vulSeverityList,
      vulId: '',
      vulSeverity: ''
    };
  },
  computed:{
    ...mapGetters([
      'getProductName'
    ])
  },
  watch: {
    severity(newVal) {
      this.vulSeverity = newVal
      this.search()
    },
    packageId() {
      this.search()
    }
  },
  methods: {
    search() {
      this.pagination.pageNum = 1
      this.queryPackageVulnerability()
    },
    handlePageChange(val: number) {
      this.pagination.pageNum = val
      this.queryPackageVulnerability()
    },
    handleSizeChange( val: number) {
      this.pagination.pageNum = 1
      this.pagination.pageSize = val
      this.queryPackageVulnerability()
    },
    queryPackageVulnerability() {
      if(this.isInDialog) {
        let str = `page=${this.pagination.pageNum - 1}&size=${this.pagination.pageSize}`
        if(this.packageId) {
          str = `${str}&packageId=${this.packageId}`
        }
        if(this.vulSeverity) {
          str = `${str}&severity=${this.vulSeverity}`
        }
        if(this.vulId) {
          str = `${str}&vulId=${this.vulId}`
        }
        SbomDataService.queryVulnerability(this.productName, str)
        .then((response: ResponseData) => {
          this.tableData = response.data.content;
          this.pagination.total = response.data.totalElements;
        })
        .catch((e: any) => {
          if (e.response && e.response.status == 500) {
            ElMessage({
            message: e.response.data,
            type: 'error'
            })
          }
          this.tableData = []
          this.pagination.total = 0
        });
      } else {
        let str = `page=${this.pagination.pageNum - 1}&size=${this.pagination.pageSize}`
        if(this.vulSeverity) {
          str = `${str}&severity=${this.vulSeverity}`
        }
        if(this.vulId) {
          str = `${str}&vulId=${this.vulId}`
        }
        SbomDataService.queryPackageVulnerability(
          this.packageId, 
          str
        )
          .then((response: ResponseData) => {
            this.tableData = response.data.content;
            this.pagination.total = response.data.totalElements;
          })
          .catch((e: any) => {
            if (e.response && e.response.status == 500) {
              ElMessage({
              message: e.response.data,
              type: 'error'
              })
            }
            this.tableData = []
            this.pagination.total = 0
          });
      }
    },
    goPath(item: any) {
      if(item.references && item.references.length) {
        const url = item.references[0].second
        window.open(url, '_blank')
      }
    },
    formatCellColor(score: number) {
      if(score <= 0) {
        return 'none'
      } else if (score > 0 && score < 4) {
        return 'low'
      } else if (score >= 4 && score < 7) {
        return 'medium'
      } else if (score >= 7 && score < 9) {
        return 'high'
      } else if (score >= 9) {
        return 'critical'
      } else {
        return ''
      }
    },
    openEchart(rowInfo) {
      this.showEchartDialog = true
      this.chartData = {}
      this.getChartData(rowInfo.vulId)
    },
    getChartData(vulId: string) {
      SbomDataService.queryVulImpact(this.productName, vulId)
      .then((response: ResponseData) => {
        if(response.data.nodes.length) {
          let dCount = 0
          let pCount = 0
          const dTotla = response.data.nodes.filter(node => node.nodeType === 'dependency')
          const pTotal = response.data.nodes.filter(node => node.nodeType === 'package')
          const grid = 220
          response.data.nodes.map(node => {
            const item = this.graphColors.find(tmp => tmp.prop === node.nodeType)
            node.color = item?.color
            if(node.nodeType === 'dependency') {
              node.y = (node.y + dCount * grid)
              dCount += 1
            } else if(node.nodeType === 'package') {
              node.y = (node.y + (dTotla.length + pCount -1) * grid)
              pCount += 1
            }else if(node.nodeType === 'transitiveDep') {
              node.y = (node.y + (dTotla.length + pTotal.length - 2) * grid)
            }
          })
        }
        this.chartData = response.data
      })
      .catch((e: any) => {
        if (e.response && e.response.status == 500) {
          ElMessage({
          message: e.response.data,
          type: 'error'
          })
        }
        this.chartData = []
      });
    },
    echartsClick(name, params) {
      const { nodeType, elementId } = params.value
      if(elementId && nodeType && nodeType !== 'vulnerability') {
        let flag 
        let productName 
        if(this.getProductName) {
          flag = this.getProductName && this.getProductName.includes('openEuler')
          productName = this.getProductName
        } else {
          flag = this.$route.params.flag || false
          productName = this.$route.query.productName || ''
        }
        const { href } = this.$router.resolve({
          path: `/sbomPackageDetail/${elementId}/${flag}`,
          query: {
            productName: productName
          }
        })
        window.open(href, '_blank')
      }
    }
  },
  mounted() {
    this.vulSeverity = this.severity
    this.queryPackageVulnerability();
  },
});
</script>

<style lang="less" scoped>
.packageBug-container{
  padding-top: 20px;
  .query-list{
    margin-bottom: 20px;
    padding-right: 20px;
  }
}

</style>